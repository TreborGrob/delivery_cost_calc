name: Deploy with Docker Compose

on:
  push:
    branches: [main]

env:
  DEPLOY_DIR: /root/amount-shipping-deploy

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install SSH Key
        uses: webfactory/ssh-agent@v0.9.0 # Обновил до актуальной версии
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 1. Сначала создаем папку, иначе rsync может выдать ошибку
      - name: Create project directory
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ${{ env.DEPLOY_DIR }}"

      # 2. Копируем файлы (исключая лишнее, чтобы не забить диск сервера)
      - name: Copy project files to server
        run: |
          rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }}" \
            --exclude '.git*' \
            --exclude '.env' \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ env.DEPLOY_DIR }}/

      # 3. Создаем .env и запускаем docker compose
      - name: Deploy on server
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} <<EOF
            cd ${{ env.DEPLOY_DIR }}
            
            # Пишем .env
            cat <<EOT > .env
            TOKEN=${{ secrets.TOKEN }}
            ADMIN=${{ secrets.ADMIN }}
            CDEK_LOGIN=${{ secrets.CDEK_LOGIN }}
            CDEK_PASSWORD=${{ secrets.CDEK_PASSWORD }}
            EOT
            chmod 600 .env

            # Очистка и запуск
            # Проверяем наличие файла перед запуском, чтобы получить внятный лог в CI
            if [ -f "docker-compose.yml" ]; then
              docker compose down || true
              docker compose up -d --build --remove-orphans
            else
              echo "Error: docker-compose.yml not found in ${{ env.DEPLOY_DIR }}"
              exit 1
            fi
          EOF
